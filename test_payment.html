<!DOCTYPE html>
<html>
<head>
    <title>Test Payment</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<button id="pay-btn">Pay Now</button>

<script>
const payBtn = document.getElementById("pay-btn");

payBtn.onclick = async function () {

    try {
        // ðŸ”’ Disable button to prevent spam clicking
        payBtn.disabled = true;
        payBtn.innerText = "Processing...";

        // STEP 1: Create Order
        const response = await fetch(
            "https://subscription-bot-278g.onrender.com/payment/create-order?plan_id=699fe8d0a3174f92c5146355&user_id=1368186248",
            { method: "POST" }
        );

        if (!response.ok) {
            throw new Error("Order creation failed");
        }

        const data = await response.json();

        if (!data.order_id) {
            throw new Error("Invalid order response");
        }

        const options = {
            key: data.key_id,
            amount: data.amount,
            currency: "INR",
            name: "Your Platform Name",
            description: "Subscription Payment",
            order_id: data.order_id,

            handler: async function (response) {

                try {
                    const verifyResponse = await fetch(
                        "https://subscription-bot-278g.onrender.com/payment/verify",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature
                            })
                        }
                    );

                    const result = await verifyResponse.json();

                    alert("Payment Verified & Subscription Activated");

                } catch (err) {
                    alert("Verification failed. Please contact support.");
                    console.error(err);
                } finally {
                    payBtn.disabled = false;
                    payBtn.innerText = "Pay Now";
                }
            },

            modal: {
                ondismiss: function () {
                    // If user closes payment popup
                    payBtn.disabled = false;
                    payBtn.innerText = "Pay Now";
                }
            },

            theme: {
                color: "#3399cc"
            }
        };

        const rzp = new Razorpay(options);
        rzp.open();

    } catch (err) {
        console.error("Error:", err);
        alert("Something went wrong. Please try again.");
        payBtn.disabled = false;
        payBtn.innerText = "Pay Now";
    }
};
</script>

</body>
</html>